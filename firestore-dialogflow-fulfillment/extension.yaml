name: firestore-dialogflow-fulfillment
version: 0.0.2
specVersion: v1beta

displayName: Firestore DialogFlow Fulfillment
description: TODO

license: Apache-2.0 # The license you want for the extension
sourceUrl: https://github.com/FirebaseExtended/experimental-extensions/tree/main/firestore-dialogflow-fulfillment

author:
  authorName: Firebase
  url: https://firebase.google.com

billingRequired: true

apis:
  - apiName: dialogflow.googleapis.com
    reason: Powers all DialogFlow tasks performed by the extension.
  - apiName: calendar-json.googleapis.com
    reason: Powers all Calendar tasks performed by the extension.

roles:
  - role: datastore.user
    reason: Allows the extension to write to your Firestore Database instance.
  - role: dialogflow.client
    reason: Allows the extension to detect intents.

resources:
  - name: createDialogflowAgent
    type: firebaseextensions.v1beta.function
    description:
      Create a new agent named ${param:AGENT_NAME} and set-up required intents.
    properties:
      location: ${param:LOCATION}
      runtime: nodejs14
      httpsTrigger: {}
  - name: newConversation
    type: firebaseextensions.v1beta.function
    description: todo
    properties:
      location: ${LOCATION}
      runtime: nodejs14
      httpsTrigger: {}
  - name: newMessage
    type: firebaseextensions.v1beta.function
    description: todo
    properties:
      location: ${LOCATION}
      runtime: nodejs14
      httpsTrigger: {}
  - name: onNewMessage
    type: firebaseextensions.v1beta.function
    description: todo
    properties:
      location: ${LOCATION}
      eventTrigger:
        eventType: providers/cloud.firestore/eventTypes/document.create
        resource: projects/${PROJECT_ID}/databases/(default)/documents/conversations/{conversationId}/messages/{messageId}
  - name: dialogflowFulfillment
    type: firebaseextensions.v1beta.function
    description: TODO
    properties:
      location: ${LOCATION}
      runtime: nodejs14
      httpsTrigger: {}

# lifecycleEvents:
#   onInstall:
#     function: createDialogflowAgent
#     processingMessage: "Create a new agent named ${param:AGENT_NAME} and set-up required intents."

params:
  - param: LOCATION
    label: Cloud Functions location
    description: >-
      Where do you want to deploy the functions created for this extension?
      You usually want a location close to your database. Realtime Database
      instances are located in `us-central1`. For help selecting a
      location, refer to the [location selection
      guide](https://firebase.google.com/docs/functions/locations).
    type: select
    options:
      - label: Iowa (us-central1)
        value: us-central1
      - label: South Carolina (us-east1)
        value: us-east1
      - label: Northern Virginia (us-east4)
        value: us-east4
      - label: Belgium (europe-west1)
        value: europe-west1
      - label: London (europe-west2)
        value: europe-west2
      - label: Frankfurt (europe-west3)
        value: europe-west3
      - label: Hong Kong (asia-east2)
        value: asia-east2
      - label: Tokyo (asia-northeast1)
        value: asia-northeast1
    default: us-central1
    required: true
    immutable: true
  - param: CALENDAR_ID
    label: Calendar ID
    description: >-
      The ID of the calendar to use for scheduling events.
    type: string
    default: ""
    required: true
  - param: DEFAULT_DURATION
    label: Default event duration
    description: >-
      The default duration of events in minutes.
    type: string
    default: 30
    required: false
  - param: LANGUAGE_CODE
    label: The language code of the DialogFlow agent.
    description: >-
      The language code of the DialogFlow agent.
    # TODO - add a list of supported languages
    type: string
    default: "en"
    required: false
  - param: TIMEZONE
    label: The timezone of the event to be scheduled.
    description: >-
      The timezone of the event to be scheduled.
    # TODO - add a list of timezones
    type: string
    default: "UTC"
    required: false
  - param: AGENT_NAME
    label: The diaplay name of the DialogFlow agent.
    description: >-
      The diaplay name of the DialogFlow agent.
    type: string
    required: true
    immutable: true

